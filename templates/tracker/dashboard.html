{% extends 'tracker/base.html' %}

{% block title %}Dashboard - Income Tracker{% endblock %}

{% block content %}
{% csrf_token %}
<div class="relative pt-8">
    <!-- Main Content without right margin since clock will be in nav -->
    <div class="w-full px-6">
        <!-- Welcome Section -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Welcome back, {{ user.first_name|default:user.username }}</h1>
                    <p class="mt-2 text-gray-600">Here's your financial overview for today</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div id="clock" class="text-2xl font-bold text-gray-900"></div>
                        <div id="date" class="text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards with Glassmorphism -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <!-- Income Card -->
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative bg-white/90 backdrop-blur-xl rounded-xl shadow-xl p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center mb-3">
                                <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-arrow-down text-2xl text-blue-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Total Income</h3>
                            </div>
                            <p class="text-3xl font-bold text-gray-900 mb-1" id="total-income">₹{{ total_income }}</p>
                            <div class="text-sm text-gray-500">Monthly earnings</div>
                        </div>
                        <div class="w-24 h-24 rounded-full bg-blue-100/50 absolute -right-6 -top-6"></div>
                    </div>
                </div>
            </div>

            <!-- Expenses Card -->
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-red-500 to-red-600 rounded-xl blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative bg-white/90 backdrop-blur-xl rounded-xl shadow-xl p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center mb-3">
                                <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-arrow-up text-2xl text-red-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Total Expenses</h3>
                            </div>
                            <p class="text-3xl font-bold text-gray-900 mb-1" id="total-expenses">₹{{ total_expenses }}</p>
                            <div class="text-sm text-gray-500">Monthly spending</div>
                        </div>
                        <div class="w-24 h-24 rounded-full bg-red-100/50 absolute -right-6 -top-6"></div>
                    </div>
                </div>
            </div>

            <!-- Balance Card -->
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-green-500 to-green-600 rounded-xl blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative bg-white/90 backdrop-blur-xl rounded-xl shadow-xl p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center mb-3">
                                <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-wallet text-2xl text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Balance</h3>
                            </div>
                            <p class="text-3xl font-bold text-gray-900 mb-1" id="balance">₹{{ balance }}</p>
                            <div class="text-sm text-gray-500">Current balance</div>
                        </div>
                        <div class="w-24 h-24 rounded-full bg-green-100/50 absolute -right-6 -top-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Add Income -->
            <a href="{% url 'add_income' %}" class="group relative bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-green-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-plus text-green-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Add Income</h3>
                        <p class="text-sm text-gray-600">Record earnings</p>
                    </div>
                </div>
            </a>

            <!-- Add Expense -->
            <a href="{% url 'add_expense' %}" class="group relative bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-red-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-minus text-red-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Add Expense</h3>
                        <p class="text-sm text-gray-600">Record spending</p>
                    </div>
                </div>
            </a>

            <!-- View Transactions -->
            <a href="{% url 'transactions' %}" class="group relative bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-list text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Transactions</h3>
                        <p class="text-sm text-gray-600">View history</p>
                    </div>
                </div>
            </a>

            <!-- Manage Budget -->
            <a href="{% url 'budget' %}" class="group relative bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-purple-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-chart-pie text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Budget</h3>
                        <p class="text-sm text-gray-600">Manage limits</p>
                    </div>
                </div>
            </a>

            <!-- Savings Goals -->
            <a href="{% url 'savings_goals' %}" class="group relative bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-piggy-bank text-indigo-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Savings</h3>
                        <p class="text-sm text-gray-600">Track goals</p>
                    </div>
                </div>
            </a>

            <!-- Financial Insights -->
            <a href="{% url 'finance_insights' %}" class="group relative bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-amber-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-chart-line text-amber-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Insights</h3>
                        <p class="text-sm text-gray-600">View analytics</p>
                    </div>
                </div>
            </a>

            <!-- Categories -->
            <a href="{% url 'manage_categories' %}" class="group relative bg-gradient-to-br from-teal-50 to-teal-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-teal-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-tags text-teal-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Categories</h3>
                        <p class="text-sm text-gray-600">Manage tags</p>
                    </div>
                </div>
            </a>

            <!-- Profile Settings -->
            <a href="{% url 'profile' %}" class="group relative bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <div class="bg-gray-500/10 p-3 rounded-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-user-cog text-gray-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Settings</h3>
                        <p class="text-sm text-gray-600">Your profile</p>
                    </div>
                </div>
            </a>
        </div>

        <!-- Main Content Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Recent Transactions -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">Recent Transactions</h2>
                    <a href="{% url 'transactions' %}" class="text-primary hover:text-blue-700 flex items-center">
                        <span>View All</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </a>
            </div>

                {% if recent_transactions %}
                <div class="space-y-4">
                    {% for transaction in recent_transactions %}
                    <div class="flex items-center justify-between p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center {% if transaction.transaction_type == 'income' %}bg-green-100{% else %}bg-red-100{% endif %}">
                                <i class="fas {% if transaction.transaction_type == 'income' %}fa-arrow-down text-green-600{% else %}fa-arrow-up text-red-600{% endif %}"></i>
                            </div>
                        <div>
                            <p class="font-medium text-gray-800">{{ transaction.description }}</p>
                            <p class="text-sm text-gray-500">{{ transaction.date }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold {% if transaction.transaction_type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}₹{{ transaction.amount }}
                            </p>
                            <span class="text-xs px-2 py-1 rounded-full {% if transaction.transaction_type == 'income' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ transaction.transaction_type|title }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-receipt text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-gray-500">No recent transactions</p>
                </div>
                {% endif %}
        </div>

            <!-- Budget Overview -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">Budget Overview</h2>
                <a href="{% url 'budget' %}" class="text-primary hover:text-blue-700 flex items-center">
                    <span>Manage Budgets</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            
            {% if budgets %}
                <div class="space-y-4">
                {% for budget in budgets %}
                    <div class="p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center {% if budget.percentage_used >= 100 %}bg-red-100{% elif budget.percentage_used >= 80 %}bg-yellow-100{% else %}bg-green-100{% endif %}">
                                    <i class="fas fa-wallet text-lg {% if budget.percentage_used >= 100 %}text-red-600{% elif budget.percentage_used >= 80 %}text-yellow-600{% else %}text-green-600{% endif %}"></i>
                            </div>
                            <div>
                                    <h3 class="font-medium text-gray-800">{{ budget.category.name }}</h3>
                                <p class="text-sm text-gray-500">Monthly Budget</p>
                            </div>
                        </div>
                            <span class="text-sm font-medium {% if budget.percentage_used >= 100 %}text-red-600{% elif budget.percentage_used >= 80 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ budget.percentage_used|floatformat:1 }}%
                            </span>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div class="h-2 rounded-full {% if budget.percentage_used >= 100 %}bg-red-600{% elif budget.percentage_used >= 80 %}bg-yellow-500{% else %}bg-green-600{% endif %}" 
                                style="width: {% if budget.percentage_used > 100 %}100{% else %}{{ budget.percentage_used }}{% endif %}%"></div>
                        </div>
                        
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">₹{{ budget.spent }} / ₹{{ budget.amount }}</span>
                            <span class="font-medium {% if budget.remaining < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                ₹{{ budget.remaining }} remaining
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-wallet text-2xl text-gray-400"></i>
            </div>
                    <p class="text-gray-500">No budget allocations set yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Savings Goals Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-800">Savings Goals</h2>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'savings_analytics' %}" class="text-primary hover:text-blue-700 flex items-center">
                        <i class="fas fa-chart-pie mr-2"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="{% url 'savings_goals' %}" class="text-primary hover:text-blue-700 flex items-center">
                        <span>Manage Goals</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>
            
            {% if savings_goals %}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% for goal in savings_goals %}
                <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-100">
                                <i class="fas fa-piggy-bank text-lg text-blue-600"></i>
                            </div>
                            <div>
                            <h3 class="font-medium text-gray-800">{{ goal.name }}</h3>
                                <p class="text-sm text-gray-500">₹{{ goal.monthly_contribution }} monthly</p>
                            </div>
                        </div>
                        
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Progress</span>
                            <span class="font-medium">{{ goal.percentage_complete|floatformat:1 }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full bg-blue-600" style="width: {{ goal.percentage_complete }}%"></div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">₹{{ goal.current_amount }}</span>
                            <span class="text-gray-600">of ₹{{ goal.target_amount }}</span>
                        </div>
                        </div>

                        {% if goal.auto_debit_enabled %}
                    <div class="mt-3 text-xs text-gray-500">
                            <i class="fas fa-calendar-alt mr-1"></i> 
                            {% if goal.days_until_next_debit <= 0 %}
                                <span class="font-medium text-blue-700">Auto-debit today at {{ goal.debit_time|time:"g:i A" }}</span>
                            {% elif goal.days_until_debit == 1 %}
                                Auto-debit tomorrow at {{ goal.debit_time|time:"g:i A" }}
                            {% else %}
                                Next debit: {{ goal.next_debit_date|date:"M d" }} at {{ goal.debit_time|time:"g:i A" }}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-3">
                    <i class="fas fa-piggy-bank text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500">No savings goals set yet</p>
            </div>
            {% endif %}
        </div>

        <!-- Smart Recommendations -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
                Smart Recommendations
            </h2>
            
            {% if recommendations %}
            <div class="space-y-4">
                    {% for recommendation in recommendations %}
                <div class="p-4 rounded-lg {% if recommendation.type == 'warning' %}bg-red-50 border-l-4 border-red-500
                    {% elif recommendation.type == 'success' %}bg-green-50 border-l-4 border-green-500
                    {% else %}bg-blue-50 border-l-4 border-blue-500{% endif %}">
                    <h3 class="font-medium {% if recommendation.type == 'warning' %}text-red-800
                                {% elif recommendation.type == 'success' %}text-green-800
                                {% else %}text-blue-800{% endif %} mb-1">
                                {{ recommendation.title }}
                            </h3>
                            <p class="text-sm text-gray-700 mb-2">{{ recommendation.description }}</p>
                            <p class="text-sm font-medium text-gray-600">
                                <i class="fas fa-arrow-right mr-1"></i>
                                {{ recommendation.action }}
                            </p>
                        </div>
                    {% endfor %}
            </div>
                {% else %}
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-3">
                    <i class="fas fa-check-circle text-2xl text-green-600"></i>
                    </div>
                <p class="text-gray-500">Great job! We don't have any recommendations right now.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block nav_right %}
<div class="flex items-center space-x-4">
    <div class="text-right">
        <div id="clock" class="text-lg font-semibold text-gray-800"></div>
        <div id="date" class="text-sm text-gray-600"></div>
    </div>
    <div class="h-8 w-px bg-gray-300"></div>
    <div class="flex items-center space-x-2">
        <a href="{% url 'profile' %}" class="text-gray-600 hover:text-gray-900">
            <i class="fas fa-user-circle text-xl"></i>
        </a>
        <a href="{% url 'logout' %}" class="text-gray-600 hover:text-gray-900">
            <i class="fas fa-sign-out-alt"></i>
        </a>
    </div>
</div>
{{ block.super }}
{% endblock %}

{% block extra_js %}
<script>
function updateClock() {
    const clockElement = document.getElementById('clock');
    const dateElement = document.getElementById('date');
    
    if (!clockElement || !dateElement) {
        console.warn('Clock or date elements not found');
        return;
    }

    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: true,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    }).replace(/^0/, '');  // Remove leading zero
    const dateString = now.toLocaleDateString('en-US', { 
        weekday: 'short',
        month: 'short',
        day: 'numeric'
    });
    
    clockElement.textContent = timeString;
    dateElement.textContent = dateString;
}

function checkTransactions() {
    fetch('/check-transactions/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.processed_transactions && data.processed_transactions.length > 0) {
            data.processed_transactions.forEach(transaction => {
                const statusElement = document.querySelector(`.transaction-status[data-id="${transaction.id}"]`);
                if (statusElement) {
                    statusElement.innerHTML = `<span class="completed px-2 py-1 rounded text-sm bg-green-100 text-green-800">Completed</span>`;
                }
            });
            // Refresh the page after 3 seconds to update balances
            setTimeout(() => window.location.reload(), 3000);
        }
    });
}

// Update clock every second
setInterval(updateClock, 1000);

// Check transactions every minute
setInterval(checkTransactions, 60000);

// Initial calls
updateClock();
checkTransactions();

function markNotificationRead(notificationId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/mark-notification-read/${notificationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Find and remove the notification element
            const notification = document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
            if (notification) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    notification.remove();
                    // Check if there are no more notifications
                    const notificationsContainer = document.querySelector('.notifications-container');
                    if (notificationsContainer && !notificationsContainer.querySelector('.notification-item')) {
                        notificationsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No notifications</p>';
                    }
                }, 300);
            }
        } else {
            console.error('Failed to mark notification as read');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function updateDashboardData() {
    fetch('/api/dashboard-stats/')
        .then(response => response.json())
        .then(data => {
            console.log('Received dashboard data:', data); // Debug log
            
            // Update amounts
            const totalIncome = document.querySelector('#total-income');
            const totalExpenses = document.querySelector('#total-expenses');
            const balance = document.querySelector('#balance');
            
            if (totalIncome) totalIncome.textContent = '₹' + data.total_income;
            if (totalExpenses) totalExpenses.textContent = '₹' + data.total_expenses;
            if (balance) balance.textContent = '₹' + data.balance;
        })
        .catch(error => {
            console.error('Error updating dashboard:', error);
        });
}

// Update dashboard data every 30 seconds
setInterval(updateDashboardData, 30000);

// Initial update
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded, updating dashboard...'); // Debug log
    updateDashboardData();
    // Update when a new transaction is added
    document.addEventListener('transactionAdded', () => {
        console.log('Transaction added, updating dashboard...'); // Debug log
        updateDashboardData();
    });
});
</script>
{% endblock %}