{% extends 'tracker/base.html' %}
{% load custom_filters %}

{% block title %}Financial Insights - Income Tracker{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-5">Financial Insights</h1>
    <p class="text-gray-600">Detailed visualizations to help you understand your spending and saving patterns.</p>
</div>

<!-- Add this section right after the opening content block, before the Financial Health Summary -->
<div class="grid md:grid-cols-3 gap-6 mb-8">
    <div class="bg-primary text-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-2">Total Income</h3>
        <p class="text-3xl font-bold">₹{{ total_income }}</p>
    </div>
    <div class="bg-red-600 text-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-2">Total Expenses</h3>
        <p class="text-3xl font-bold">₹{{ total_expenses }}</p>
    </div>
    <div class="bg-blue-600 text-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-2">Top Spent Category</h3>
        <p class="text-3xl font-bold">{{ top_category_name }}</p>
        <p class="text-xl mt-2">₹{{ top_category_amount }}</p>
    </div>
</div>

<!-- Financial Health Summary -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Financial Health Summary</h2>
    
    <div class="grid md:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <h3 class="text-sm font-medium text-blue-700 mb-2">Savings Rate</h3>
            <p class="text-2xl font-bold text-blue-800">{{ savings_rate|floatformat:1 }}%</p>
            <p class="text-xs text-blue-600 mt-1">of your income goes to savings</p>
        </div>
        
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <h3 class="text-sm font-medium text-green-700 mb-2">Expense Trend</h3>
            <p class="text-2xl font-bold">
                {% if expense_trend < 0 %}
                <span class="text-green-600">↓ {{ expense_trend|multiply:-1|floatformat:1 }}%</span>
                {% elif expense_trend > 0 %}
                <span class="text-red-600">↑ {{ expense_trend|floatformat:1 }}%</span>
                {% else %}
                <span class="text-gray-600">0%</span>
                {% endif %}
            </p>
            <p class="text-xs text-green-600 mt-1">compared to previous month</p>
        </div>
        
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <h3 class="text-sm font-medium text-purple-700 mb-2">Goal Progress</h3>
            <p class="text-2xl font-bold text-purple-800">{{ avg_goal_progress|floatformat:1 }}%</p>
            <p class="text-xs text-purple-600 mt-1">average across all active goals</p>
        </div>
        
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg border border-amber-200">
            <h3 class="text-sm font-medium text-amber-700 mb-2">Budget Adherence</h3>
            <p class="text-2xl font-bold text-amber-800">{{ budget_adherence|floatformat:1 }}%</p>
            <p class="text-xs text-amber-600 mt-1">of budgets are on track</p>
        </div>
    </div>
</div>

<!-- Income vs Expenses vs Savings -->
<div class="grid md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Financial Flow</h2>
        <div style="height: 300px; position: relative;">
            <canvas id="financialFlowChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Category Breakdown</h2>
        <div style="height: 300px; position: relative;">
            <canvas id="categoryBreakdownChart"></canvas>
        </div>
    </div>
</div>

<!-- Trend Analysis -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Financial Trends</h2>
    
    <div class="flex mb-4">
        <div class="inline-flex rounded-md shadow-sm">
            <button id="trend-3m" class="trend-btn px-4 py-2 text-sm font-medium text-blue-700 bg-white border border-blue-300 rounded-l-lg hover:bg-blue-50 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 active-trend">
                3 Months
            </button>
            <button id="trend-6m" class="trend-btn px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700">
                6 Months
            </button>
            <button id="trend-1y" class="trend-btn px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-300 rounded-r-lg hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700">
                1 Year
            </button>
        </div>
    </div>
    
    <div style="height: 300px; position: relative;">
        <canvas id="trendAnalysisChart"></canvas>
    </div>
</div>

<!-- Savings Goals Forecast and Projection -->
<div class="grid md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Savings Projection</h2>
        <div style="height: 300px; position: relative;">
            <canvas id="savingsProjectionChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Income Distribution</h2>
        <div style="height: 300px; position: relative;">
            <canvas id="incomeDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Advanced Auto-Debit Calendar -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-calendar-alt text-indigo-500 mr-2"></i>
                Financial Calendar
            </h2>
            <p class="text-sm text-gray-600 mt-1">Track all your scheduled transactions</p>
        </div>
        
        <!-- Calendar Navigation -->
        <div class="flex items-center space-x-4">
            <!-- Legend -->
            <div class="hidden md:flex items-center space-x-4 mr-4">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span>
                    <span class="text-xs text-gray-600">Auto-debits</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>
                    <span class="text-xs text-gray-600">Manual debits</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-purple-500 mr-1"></span>
                    <span class="text-xs text-gray-600">Transfers</span>
                </div>
            </div>
            
            <!-- Month Navigation -->
            <div class="flex space-x-2">
                <button id="prev-month" class="text-sm text-gray-600 hover:text-gray-900 p-1">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="current-month-display" class="text-sm font-medium text-gray-700 px-2">June 2023</span>
                <button id="next-month" class="text-sm text-gray-600 hover:text-gray-900 p-1">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Legend -->
    <div class="flex md:hidden items-center justify-center space-x-4 mb-4">
        <div class="flex items-center">
            <span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span>
            <span class="text-xs text-gray-600">Auto-debits</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>
            <span class="text-xs text-gray-600">Manual debits</span>
        </div>
        <div class="flex items-center">
            <span class="w-3 h-3 rounded-full bg-purple-500 mr-1"></span>
            <span class="text-xs text-gray-600">Transfers</span>
        </div>
    </div>
    
    <div id="calendar-container">
        <div class="grid grid-cols-7 gap-1">
            <div class="text-center p-2 font-medium text-gray-600">Mon</div>
            <div class="text-center p-2 font-medium text-gray-600">Tue</div>
            <div class="text-center p-2 font-medium text-gray-600">Wed</div>
            <div class="text-center p-2 font-medium text-gray-600">Thu</div>
            <div class="text-center p-2 font-medium text-gray-600">Fri</div>
            <div class="text-center p-2 font-medium text-gray-600">Sat</div>
            <div class="text-center p-2 font-medium text-gray-600">Sun</div>
            
            <div id="calendar-days" class="grid grid-cols-7 col-span-7 gap-1"></div>
        </div>
    </div>
</div>

<!-- Financial Recommendations -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-brain text-indigo-500 mr-2"></i>
            AI-Powered Financial Recommendations
        </h2>
        <div class="text-sm text-gray-500">
            Updated {{ today|date:"F j, Y" }}
        </div>
    </div>
    
    <div class="space-y-4">
        {% if recommendations %}
            {% for recommendation in recommendations %}
                <div class="group bg-gradient-to-r relative overflow-hidden transition-all duration-300
                    {% if recommendation.type == 'warning' %}from-red-50 to-orange-50 border-l-4 border-red-500 hover:from-red-100 hover:to-orange-100
                    {% elif recommendation.type == 'success' %}from-green-50 to-emerald-50 border-l-4 border-green-500 hover:from-green-100 hover:to-emerald-100
                    {% else %}from-blue-50 to-indigo-50 border-l-4 border-blue-500 hover:from-blue-100 hover:to-indigo-100{% endif %} 
                    p-4 rounded-r-lg">
                    
                    <!-- Confidence Score Indicator -->
                    <div class="absolute top-2 right-2 flex items-center text-xs text-gray-500">
                        <span class="mr-1">AI Confidence:</span>
                        <div class="w-8 h-8 rounded-full flex items-center justify-center
                            {% if recommendation.confidence >= 0.9 %}bg-green-100 text-green-700
                            {% elif recommendation.confidence >= 0.8 %}bg-blue-100 text-blue-700
                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                            {{ recommendation.confidence|multiply:100|floatformat:0 }}%
                        </div>
                    </div>

                    <!-- Recommendation Icon and Title -->
                    <div class="flex items-start mb-2">
                        <div class="mr-3">
                            {% if recommendation.type == 'warning' %}
                                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                            {% elif recommendation.type == 'success' %}
                                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            {% else %}
                                <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-lg 
                                {% if recommendation.type == 'warning' %}text-red-800
                                {% elif recommendation.type == 'success' %}text-green-800
                                {% else %}text-blue-800{% endif %}">
                                {{ recommendation.title }}
                            </h3>
                            <p class="text-sm text-gray-700 mt-1">{{ recommendation.description }}</p>
                        </div>
                    </div>

                    <!-- Action Steps -->
                    <div class="ml-9 mt-3 flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">
                                <i class="fas fa-arrow-right mr-2"></i>
                                {{ recommendation.action }}
                            </p>
                        </div>
                        {% if recommendation.metric is not None %}
                            <div class="ml-4 px-3 py-1 rounded-full text-xs font-medium
                                {% if recommendation.type == 'warning' %}bg-red-100 text-red-800
                                {% elif recommendation.type == 'success' %}bg-green-100 text-green-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ recommendation.metric|floatformat:1 }}%
                            </div>
                        {% endif %}
                    </div>

                    <!-- Hover Effect Content -->
                    <div class="mt-3 pt-3 border-t border-gray-200 hidden group-hover:block transition-all duration-300">
                        <div class="text-xs text-gray-600">
                            <i class="fas fa-chart-line mr-1"></i>
                            Based on your financial data from the past 30 days
                        </div>
                    </div>
                </div>
            {% endfor %}

            <!-- View More Button -->
            {% if recommendations|length > 3 %}
                <button id="viewMoreRecommendations" class="mt-4 w-full py-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                    <i class="fas fa-chevron-down mr-1"></i>
                    View More Recommendations
                </button>
            {% endif %}
        {% else %}
            <div class="text-center py-8">
                <div class="bg-green-50 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check-circle text-3xl text-green-500"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">You're Doing Great!</h3>
                <p class="text-gray-600">Continue tracking your finances to receive personalized recommendations.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Financial Flow Chart
    try {
        const financialFlowCtx = document.getElementById('financialFlowChart').getContext('2d');
        const monthlyLabels = JSON.parse('{{ monthly_labels|escapejs }}');
        const incomeData = JSON.parse('{{ income_data|escapejs }}');
        const expenseData = JSON.parse('{{ expense_data|escapejs }}');
        const savingsData = JSON.parse('{{ savings_data|escapejs }}');

        new Chart(financialFlowCtx, {
            type: 'bar',
            data: {
                labels: monthlyLabels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeData,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)', // Green
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 1
                    },
                    {
                        label: 'Savings',
                        data: savingsData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // Blue
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '₹' + context.raw;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating financial flow chart:', error);
    }
    
    // Category Breakdown Chart
    try {
        const categoryCtx = document.getElementById('categoryBreakdownChart').getContext('2d');
        const categoryNames = JSON.parse('{{ category_names|escapejs }}');
        const categoryAmounts = JSON.parse('{{ category_amounts|escapejs }}');

        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryNames,
                datasets: [{
                    data: categoryAmounts,
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',   // Blue
                        'rgba(16, 185, 129, 0.7)',   // Green
                        'rgba(139, 92, 246, 0.7)',   // Purple
                        'rgba(245, 158, 11, 0.7)',   // Amber
                        'rgba(239, 68, 68, 0.7)',    // Red
                        'rgba(6, 182, 212, 0.7)',    // Cyan
                        'rgba(236, 72, 153, 0.7)',   // Pink
                        'rgba(99, 102, 241, 0.7)',   // Indigo
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ₹${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating category breakdown chart:', error);
    }
    
    // Trend Analysis Chart (initial with 3 months of data)
    let trendChart; 
    try {
        const trendCtx = document.getElementById('trendAnalysisChart').getContext('2d');
        const trendLabels3m = JSON.parse('{{ trend_labels_3m|escapejs }}');
        const incomeTrend3m = JSON.parse('{{ income_trend_3m|escapejs }}');
        const expenseTrend3m = JSON.parse('{{ expense_trend_3m|escapejs }}');
        const savingsTrend3m = JSON.parse('{{ savings_trend_3m|escapejs }}');

        trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels3m,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeTrend3m,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Expenses',
                        data: expenseTrend3m,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Savings',
                        data: savingsTrend3m,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '₹' + context.raw;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating trend analysis chart:', error);
    }
    
    // Handle trend period buttons
    document.querySelectorAll('.trend-btn').forEach(button => {
        button.addEventListener('click', function() {
            try {
                // Remove active class from all buttons
                document.querySelectorAll('.trend-btn').forEach(btn => {
                    btn.classList.remove('active-trend', 'text-blue-700', 'bg-blue-50');
                    btn.classList.add('text-gray-700');
                });
                
                // Add active class to clicked button
                this.classList.add('active-trend', 'text-blue-700', 'bg-blue-50');
                this.classList.remove('text-gray-700');
                
                // Update chart based on selected period
                const period = this.id.split('-')[1];
                
                // Parse the data for different periods
                const periodData = {
                    '3m': {
                        labels: JSON.parse('{{ trend_labels_3m|escapejs }}'),
                        income: JSON.parse('{{ income_trend_3m|escapejs }}'),
                        expenses: JSON.parse('{{ expense_trend_3m|escapejs }}'),
                        savings: JSON.parse('{{ savings_trend_3m|escapejs }}')
                    },
                    '6m': {
                        labels: JSON.parse('{{ trend_labels_6m|escapejs }}'),
                        income: JSON.parse('{{ income_trend_6m|escapejs }}'),
                        expenses: JSON.parse('{{ expense_trend_6m|escapejs }}'),
                        savings: JSON.parse('{{ savings_trend_6m|escapejs }}')
                    },
                    '1y': {
                        labels: JSON.parse('{{ trend_labels_1y|escapejs }}'),
                        income: JSON.parse('{{ income_trend_1y|escapejs }}'),
                        expenses: JSON.parse('{{ expense_trend_1y|escapejs }}'),
                        savings: JSON.parse('{{ savings_trend_1y|escapejs }}')
                    }
                };
                
                // Update chart data and labels
                trendChart.data.labels = periodData[period].labels;
                trendChart.data.datasets[0].data = periodData[period].income;
                trendChart.data.datasets[1].data = periodData[period].expenses;
                trendChart.data.datasets[2].data = periodData[period].savings;
                trendChart.update();
            } catch (error) {
                console.error('Error updating trend chart:', error);
            }
        });
    });
    
    // Savings Projection Chart
    try {
        const projectionCtx = document.getElementById('savingsProjectionChart').getContext('2d');
        const projectionLabels = JSON.parse('{{ projection_labels|escapejs }}');
        const projectionDatasets = JSON.parse('{{ projection_datasets|escapejs }}');

        new Chart(projectionCtx, {
            type: 'line',
            data: {
                labels: projectionLabels,
                datasets: projectionDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '₹' + context.raw;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating savings projection chart:', error);
    }
    
    // Income Distribution Chart
    try {
        const distributionCtx = document.getElementById('incomeDistributionChart').getContext('2d');
        const distributionData = JSON.parse('{{ distribution_data|escapejs }}');

        new Chart(distributionCtx, {
            type: 'pie',
            data: {
                labels: ['Expenses', 'Savings', 'Investments'],
                datasets: [{
                    data: distributionData,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)',    // Red
                        'rgba(59, 130, 246, 0.7)',   // Blue
                        'rgba(16, 185, 129, 0.7)',   // Green
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${percentage}% (₹${value})`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating income distribution chart:', error);
    }
    
    // Parse the calendar data from Django template
    let calendarData;
    try {
        calendarData = JSON.parse('{{ calendar_data|escapejs }}');
    } catch (error) {
        console.error('Error parsing calendar data:', error);
        calendarData = {};
    }
    
    const calendarContainer = document.getElementById('calendar-days');
    const currentMonthDisplay = document.getElementById('current-month-display');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    
    // Set initial date to current month
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    
    // Function to format currency
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    };

    // Function to render calendar
    function renderCalendar(month, year) {
        const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
        currentMonthDisplay.textContent = `${monthNames[month]} ${year}`;
        
        calendarContainer.innerHTML = '';
        
        const firstDay = new Date(year, month, 1).getDay();
        const startOffset = firstDay === 0 ? 6 : firstDay - 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Add empty cells for days before start of month
        for (let i = 0; i < startOffset; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'p-2 border rounded bg-gray-50';
            calendarContainer.appendChild(emptyCell);
        }
        
        // Generate calendar days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayCell = document.createElement('div');
            const dateData = calendarData[dateStr] || null;
            const isToday = day === currentDate.getDate() && 
                           month === currentDate.getMonth() && 
                           year === currentDate.getFullYear();
            
            dayCell.className = `relative p-2 border rounded transition-all duration-200
                               ${isToday ? 'bg-blue-50 border-blue-200' : 'bg-white'} 
                               ${dateData ? 'font-medium hover:bg-gray-50' : ''}`;
            
            // Create day header
            const dayHeader = document.createElement('div');
            dayHeader.className = 'flex justify-between items-center mb-1';
            
            const dayNumber = document.createElement('span');
            dayNumber.className = isToday ? 'font-bold text-blue-600' : '';
            dayNumber.textContent = day;
            dayHeader.appendChild(dayNumber);
            
            if (dateData) {
                const indicatorsDiv = document.createElement('div');
                indicatorsDiv.className = 'flex space-x-1';
                
                // Add indicators for each type of transaction
                if (dateData.autoDebits && dateData.autoDebits.length > 0) {
                    const indicator = document.createElement('span');
                    indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                    indicatorsDiv.appendChild(indicator);
                }
                if (dateData.manualDebits && dateData.manualDebits.length > 0) {
                    const indicator = document.createElement('span');
                    indicator.className = 'w-2 h-2 rounded-full bg-blue-500';
                    indicatorsDiv.appendChild(indicator);
                }
                if (dateData.transfers && dateData.transfers.length > 0) {
                    const indicator = document.createElement('span');
                    indicator.className = 'w-2 h-2 rounded-full bg-purple-500';
                    indicatorsDiv.appendChild(indicator);
                }
                
                dayHeader.appendChild(indicatorsDiv);
            }
            
            dayCell.appendChild(dayHeader);
            
            // Add transaction details if they exist
            if (dateData) {
                const transactionPreview = document.createElement('div');
                transactionPreview.className = 'text-xs space-y-1';
                let totalAmount = 0;
                
                // Add preview for each type of transaction
                if (dateData.autoDebits && dateData.autoDebits.length > 0) {
                    const amount = dateData.autoDebits.reduce((sum, item) => sum + item.amount, 0);
                    totalAmount += amount;
                    const preview = document.createElement('div');
                    preview.className = 'text-green-600 font-medium truncate';
                    preview.textContent = `Auto: ${formatCurrency(amount)}`;
                    transactionPreview.appendChild(preview);
                }
                
                if (totalAmount > 0) {
                    dayCell.appendChild(transactionPreview);
                    
                    // Add click handler for popup
                    dayCell.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showTransactionPopup(dateStr, dateData, totalAmount);
                    });
                }
            }
            
            calendarContainer.appendChild(dayCell);
        }
    }
    
    // Function to show transaction popup
    function showTransactionPopup(dateStr, dateData, totalAmount) {
        const popup = document.createElement('div');
        popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        
        const content = document.createElement('div');
        content.className = 'bg-white rounded-lg p-4 max-w-md w-full mx-4';
        
        let popupContent = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Transactions for ${dateStr}</h3>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add sections for each transaction type
        const sections = [
            { type: 'autoDebits', title: 'Auto-debits', color: 'green', key: 'goal' },
            { type: 'manualDebits', title: 'Manual debits', color: 'blue', key: 'description' },
            { type: 'transfers', title: 'Transfers', color: 'purple', key: 'description' }
        ];
        
        sections.forEach(({ type, title, color, key }) => {
            if (dateData[type]?.length > 0) {
                popupContent += `
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">
                            <span class="w-2 h-2 rounded-full bg-${color}-500 inline-block mr-2"></span>
                            ${title}
                        </h4>
                        <div class="space-y-2">
                            ${dateData[type].map(item => `
                                <div class="flex justify-between items-center p-2 bg-${color}-50 rounded">
                                    <span class="text-sm text-gray-700">${item[key]}</span>
                                    <span class="text-sm font-medium text-${color}-600">${formatCurrency(item.amount)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });
        
        // Add total section
        popupContent += `
            <div class="mt-4 pt-3 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">Total Transactions</span>
                    <span class="text-sm font-bold text-gray-900">${formatCurrency(totalAmount)}</span>
                </div>
            </div>
        `;
        
        content.innerHTML = popupContent;
        popup.appendChild(content);
        document.body.appendChild(popup);
        
        // Close popup handlers
        popup.addEventListener('click', function(e) {
            if (e.target === popup || e.target.closest('button')) {
                popup.remove();
            }
        });
    }
    
    // Initialize calendar
    renderCalendar(currentMonth, currentYear);
    
    // Add navigation handlers
    prevMonthBtn.addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentMonth, currentYear);
    });
    
    nextMonthBtn.addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentMonth, currentYear);
    });

    const viewMoreBtn = document.getElementById('viewMoreRecommendations');
    if (viewMoreBtn) {
        const recommendations = document.querySelectorAll('.group');
        const initialDisplay = 3;
        
        // Initially hide recommendations beyond the initial display count
        recommendations.forEach((rec, index) => {
            if (index >= initialDisplay) {
                rec.style.display = 'none';
            }
        });
        
        viewMoreBtn.addEventListener('click', function() {
            recommendations.forEach(rec => {
                rec.style.display = 'block';
            });
            viewMoreBtn.style.display = 'none';
        });
    }
});
</script>
{% endblock %} 