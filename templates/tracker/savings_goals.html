{% extends 'tracker/base.html' %}
{% load custom_filters %}

{% block title %}Savings Goals - Income Tracker{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Savings Goals</h1>
    
    <!-- New Goal Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Create New Savings Goal</h2>
        <form method="POST" action="{% url 'savings_goals' %}">
            {% csrf_token %}
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Goal Name</label>
                    <input type="text" id="name" name="name" required placeholder="New Phone, Dream Vacation..." 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                </div>
                <div>
                    <label for="target_amount" class="block text-sm font-medium text-gray-700 mb-1">Target Amount (₹)</label>
                    <input type="number" id="target_amount" name="target_amount" min="0" step="0.01" required 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                </div>
                <div>
                    <label for="monthly_contribution" class="block text-sm font-medium text-gray-700 mb-1">Monthly Contribution (₹)</label>
                    <input type="number" id="monthly_contribution" name="monthly_contribution" min="0" step="0.01" required 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                </div>
                <div>
                    <label for="target_date" class="block text-sm font-medium text-gray-700 mb-1">Target Date (Optional)</label>
                    <input type="date" id="target_date" name="target_date" 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                </div>
                <div>
                    <label for="debit_time" class="block text-sm font-medium text-gray-700 mb-1">Debit Time</label>
                    <input type="time" id="debit_time" name="debit_time" value="00:00" 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                    <p class="text-xs text-gray-500 mt-1">When should automatic debits occur? (default: midnight)</p>
                </div>
                <div>
                    <label for="debit_day" class="block text-sm font-medium text-gray-700 mb-1">Debit Day</label>
                    <select id="debit_day" name="debit_day" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                        {% for i in range_1_31 %}
                            <option value="{{ i }}">{{ i }}{% if i == 28 %} (Last day for February){% elif i == 30 %} (Last day for some months){% elif i == 31 %} (Only in 31-day months){% endif %}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        Day of month when automatic debits will occur. For months with fewer days, 
                        the last day of the month will be used instead.
                    </p>
                </div>
            </div>
            <div class="mt-4">
                <button type="submit" class="bg-primary text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i>Create Savings Goal
                </button>
            </div>
        </form>
    </div>
    
    <!-- Goals Overview -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Goals Overview</h2>
        
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-lg font-medium text-gray-700 mb-3">Completion Progress</h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="completionChart"></canvas>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-medium text-gray-700 mb-3">Auto-Debit Schedule</h3>
                {% if has_auto_debits %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex justify-between mb-3">
                        <h4 class="font-medium text-blue-800">This Month's Debits</h4>
                        <span class="text-blue-800">Total: ₹{{ monthly_auto_debit_total }}</span>
                    </div>
                    
                    <div class="space-y-3">
                        {% for debit in upcoming_auto_debits %}
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-medium">{{ debit.name }}</span>
                                {% if debit.days_until_debit <= 0 %}
                                <span class="ml-2 text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">Today</span>
                                {% elif debit.days_until_debit == 1 %}
                                <span class="ml-2 text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">Tomorrow</span>
                                {% else %}
                                <span class="text-sm text-gray-600">in {{ debit.days_until_debit }} days</span>
                                {% endif %}
                            </div>
                            <span class="font-medium">₹{{ debit.monthly_contribution }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if has_today_debits %}
                    <div class="mt-4 text-center">
                        <a href="{% url 'force_check_debits' %}" class="text-blue-700 bg-blue-100 hover:bg-blue-200 font-medium py-2 px-4 rounded inline-flex items-center process-debit-btn">
                            <i class="fas fa-sync-alt mr-2"></i> Process All Due Debits Now
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-2"></i>
                        <p>No auto-debits scheduled</p>
                        <p class="text-sm mt-2">Enable auto-debit on your goals to see the schedule here</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Add this section after the "Goals Overview" section and before "Active Goals" -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Savings Analytics</h2>
        
        <!-- Summary Statistics -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-600 text-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold mb-2">Active Goals</h3>
                <p class="text-2xl font-bold">{{ active_goals_count }}</p>
            </div>
            <div class="bg-green-600 text-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold mb-2">Total Saved</h3>
                <p class="text-2xl font-bold">₹{{ total_saved }}</p>
            </div>
            <div class="bg-purple-600 text-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold mb-2">Monthly Commitment</h3>
                <p class="text-2xl font-bold">₹{{ total_monthly }}</p>
            </div>
            <div class="bg-orange-600 text-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold mb-2">Remaining to Goal</h3>
                <p class="text-2xl font-bold">₹{{ total_remaining }}</p>
            </div>
        </div>

        <!-- Analytics Charts -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Savings Timeline Chart -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-medium text-gray-800 mb-3">Savings Growth Timeline</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="savingsTimelineChart"></canvas>
                </div>
            </div>
            
            <!-- Completion Forecast Chart -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-medium text-gray-800 mb-3">Completion Forecast</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="completionForecastChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Auto-Debit Calendar -->
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-800">Monthly Auto-Debit Calendar</h3>
                <div class="flex items-center space-x-4">
                    <button id="prevMonth" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="currentMonth" class="text-sm font-medium">January 2024</span>
                    <button id="nextMonth" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div id="calendarContainer">
                <div class="grid grid-cols-7 gap-1">
                    <div class="text-center p-2 font-medium text-gray-600">Mon</div>
                    <div class="text-center p-2 font-medium text-gray-600">Tue</div>
                    <div class="text-center p-2 font-medium text-gray-600">Wed</div>
                    <div class="text-center p-2 font-medium text-gray-600">Thu</div>
                    <div class="text-center p-2 font-medium text-gray-600">Fri</div>
                    <div class="text-center p-2 font-medium text-gray-600">Sat</div>
                    <div class="text-center p-2 font-medium text-gray-600">Sun</div>
                    
                    <div id="calendarDays" class="grid grid-cols-7 col-span-7 gap-1">
                        <!-- Calendar days will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lifetime Savings Goals -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Lifetime Savings Goals</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Family Emergency Fund -->
            <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow bg-blue-50">
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 bg-blue-100">
                            <i class="fas fa-shield-alt text-lg text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Family Emergency Fund</h3>
                            <p class="text-sm text-blue-600">6 months of expenses</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Recommended:</span>
                            <span class="font-medium">₹{{ monthly_expenses|multiply:6 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Current:</span>
                            <span class="font-medium">₹{{ emergency_fund_current }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full bg-blue-600" 
                                style="width: {{ emergency_fund_percentage }}%"></div>
                        </div>
                        <div class="text-xs text-center text-gray-600">
                            {{ emergency_fund_percentage }}% complete
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-center">
                        {% if emergency_fund_id %}
                            <a href="{% url 'edit_savings_goal' emergency_fund_id %}?add_funds=true" 
                               class="bg-blue-600 text-white text-sm py-2 px-4 rounded hover:bg-blue-700 transition-colors">
                                <i class="fas fa-plus-circle mr-1"></i> Add Funds
                            </a>
                        {% else %}
                            <form method="POST" action="{% url 'savings_goals' %}" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="name" value="Family Emergency Fund">
                                <input type="hidden" name="target_amount" value="{{ monthly_expenses|multiply:6 }}">
                                <input type="hidden" name="monthly_contribution" value="{{ monthly_expenses|multiply:0.1 }}">
                                <button type="submit" class="bg-blue-600 text-white text-sm py-2 px-4 rounded hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-plus-circle mr-1"></i> Create Goal
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Children's Education -->
            <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow bg-green-50">
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 bg-green-100">
                            <i class="fas fa-graduation-cap text-lg text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Children's Education</h3>
                            <p class="text-sm text-green-600">Long-term education fund</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Target:</span>
                            <span class="font-medium">₹{{ education_fund_target }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Current:</span>
                            <span class="font-medium">₹{{ education_fund_current }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full bg-green-600" 
                                style="width: {{ education_fund_percentage }}%"></div>
                        </div>
                        <div class="text-xs text-center text-gray-600">
                            {{ education_fund_percentage }}% complete
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-center">
                        {% if education_fund_id %}
                            <a href="{% url 'edit_savings_goal' education_fund_id %}?add_funds=true" 
                               class="bg-green-600 text-white text-sm py-2 px-4 rounded hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus-circle mr-1"></i> Add Funds
                            </a>
                        {% else %}
                            <form method="POST" action="{% url 'savings_goals' %}" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="name" value="Children's Education">
                                <input type="hidden" name="target_amount" value="5000000">
                                <input type="hidden" name="monthly_contribution" value="50000">
                                <button type="submit" class="bg-green-600 text-white text-sm py-2 px-4 rounded hover:bg-green-700 transition-colors">
                                    <i class="fas fa-plus-circle mr-1"></i> Create Goal
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Retirement Fund -->
            <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow bg-purple-50">
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 bg-purple-100">
                            <i class="fas fa-umbrella-beach text-lg text-purple-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Retirement Fund</h3>
                            <p class="text-sm text-purple-600">Secure your future</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Target:</span>
                            <span class="font-medium">₹{{ retirement_fund_target }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Current:</span>
                            <span class="font-medium">₹{{ retirement_fund_current }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full bg-purple-600" 
                                style="width: {{ retirement_fund_percentage }}%"></div>
                        </div>
                        <div class="text-xs text-center text-gray-600">
                            {{ retirement_fund_percentage }}% complete
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-center">
                        {% if retirement_fund_id %}
                            <a href="{% url 'edit_savings_goal' retirement_fund_id %}?add_funds=true" 
                               class="bg-purple-600 text-white text-sm py-2 px-4 rounded hover:bg-purple-700 transition-colors">
                                <i class="fas fa-plus-circle mr-1"></i> Add Funds
                            </a>
                        {% else %}
                            <form method="POST" action="{% url 'savings_goals' %}" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="name" value="Retirement Fund">
                                <input type="hidden" name="target_amount" value="10000000">
                                <input type="hidden" name="monthly_contribution" value="100000">
                                <button type="submit" class="bg-purple-600 text-white text-sm py-2 px-4 rounded hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-plus-circle mr-1"></i> Create Goal
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <a href="{% url 'savings_goals' %}" class="text-primary hover:text-blue-700">
                <i class="fas fa-plus-circle mr-1"></i> Create New Lifetime Goal
            </a>
        </div>
    </div>
    
    <!-- Active Goals -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Active Goals</h2>
        
        {% if goals %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for goal in goals %}
            {% if not goal.completed %}
            <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 bg-blue-100">
                            <i class="fas fa-piggy-bank text-lg text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ goal.name }}</h3>
                            <p class="text-sm text-gray-500">Saving ₹{{ goal.monthly_contribution }} monthly</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Target:</span>
                        <span class="font-medium">₹{{ goal.target_amount }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Saved:</span>
                        <span class="font-medium">₹{{ goal.current_amount }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-600">Remaining:</span>
                        <span class="font-medium">₹{{ goal.remaining_amount }}</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                        <div class="h-2.5 rounded-full bg-blue-600" 
                            style="width: {{ goal.percentage_complete }}%"></div>
                    </div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>{{ goal.percentage_complete|floatformat:1 }}% complete</span>
                        {% if goal.months_remaining %}
                            <span>~{{ goal.months_remaining }} months left</span>
                        {% endif %}
                    </div>
                    
                    <!-- Enhance auto-debit status in the Active Goals section -->
                    {% if goal.auto_debit_enabled %}
                    <div class="flex items-center text-xs text-gray-600 mt-2">
                        <div class="w-3 h-3 rounded-full {% if goal.days_until_next_debit <= 0 %}bg-blue-500 animate-pulse{% elif goal.days_until_next_debit <= 3 %}bg-green-500{% else %}bg-gray-400{% endif %} mr-2"></div>
                        {% if goal.days_until_next_debit <= 0 %}
                            <span class="font-medium text-blue-700">Auto-debit scheduled today at {{ goal.debit_time|time:"g:i A" }}</span>
                        {% elif goal.days_until_next_debit == 1 %}
                            Auto-debit tomorrow at {{ goal.debit_time|time:"g:i A" }}
                        {% else %}
                            Next debit on {{ goal.next_debit_date|date:"M d" }} at {{ goal.debit_time|time:"g:i A" }}
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-money-bill-wave mr-1"></i> ₹{{ goal.monthly_contribution }} will be automatically deducted
                    </div>
                    {% else %}
                    <div class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-calendar-alt mr-1"></i> Auto-debit disabled
                    </div>
                    {% endif %}
                    
                    <!-- Update the Process Now button to send force parameter correctly -->
                    {% if goal.auto_debit_enabled and goal.days_until_next_debit <= 0 %}
                    <div class="mt-2 bg-green-100 p-2 rounded text-center">
                        <p class="text-xs text-green-800 mb-1">
                            {% if now.time < goal.debit_time %}
                            Auto-debit scheduled for today at {{ goal.debit_time|time:"g:i A" }}
                            {% else %}
                            Auto-debit time ({{ goal.debit_time|time:"g:i A" }}) has passed
                            {% endif %}
                        </p>
                        <a href="{% url 'force_check_debits' %}" class="text-xs font-bold bg-green-600 text-white py-1 px-3 rounded hover:bg-green-700 flex items-center justify-center mx-auto w-32 process-debit-btn">
                            <i class="fas fa-money-bill-wave mr-1"></i> Process Now
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="mt-3 flex space-x-2">
                        <a href="{% url 'edit_savings_goal' goal.id %}" class="flex-1 text-center bg-primary text-white text-sm py-2 px-3 rounded hover:bg-blue-700 transition-colors">
                            <i class="fas fa-edit mr-1"></i> Edit Goal
                        </a>
                        <a href="{% url 'edit_savings_goal' goal.id %}?add_funds=true" class="flex-1 text-center bg-green-600 text-white text-sm py-2 px-3 rounded hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus-circle mr-1"></i> Add Funds
                        </a>
                        <form method="POST" action="{% url 'delete_savings_goal' goal.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this goal?');">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:text-red-800 px-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 py-4 text-center">No active savings goals. Create one above to get started!</p>
        {% endif %}
    </div>
    
    <!-- Completed Goals -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Completed Goals</h2>
        
        {% with completed_goals=goals|dictsortreversed:"updated_at" %}
        {% if completed_goals %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for goal in completed_goals %}
            {% if goal.completed %}
            <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow border-green-200 bg-green-50">
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 bg-green-100">
                            <i class="fas fa-check-circle text-lg text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ goal.name }}</h3>
                            <p class="text-sm text-green-600">Completed!</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Target:</span>
                        <span class="font-medium">₹{{ goal.target_amount }}</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                        <div class="h-2.5 rounded-full bg-green-600" style="width: 100%"></div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="mt-3 text-right">
                        <form method="POST" action="{% url 'delete_savings_goal' goal.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this goal?');">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash mr-1"></i> Remove
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 py-4 text-center">No completed goals yet. Keep saving!</p>
        {% endif %}
        {% endwith %}
    </div>
</div>

<!-- Add JavaScript to show processing state when Process Now is clicked -->
{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Existing process buttons code
    const processButtons = document.querySelectorAll('.process-debit-btn');
    processButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            console.log('Processing button clicked');
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Processing...';
            this.classList.add('opacity-75');
            this.disabled = true;
        });
    });
    
    // Completion Chart
    try {
        const ctx = document.getElementById('completionChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ goal_names|safe }},
                datasets: [{
                    label: 'Saved',
                    data: {{ current_amounts|safe }},
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }, {
                    label: 'Remaining',
                    data: {{ remaining_amounts|safe }},
                    backgroundColor: 'rgba(209, 213, 219, 0.6)',
                    borderColor: 'rgba(209, 213, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating completion chart:', error);
    }

    // Savings Timeline Chart
    try {
        const timelineCtx = document.getElementById('savingsTimelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: {{ timeline_labels|safe }},
                datasets: {{ timeline_datasets|safe }}
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating timeline chart:', error);
    }

    // Completion Forecast Chart
    try {
        const forecastCtx = document.getElementById('completionForecastChart').getContext('2d');
        new Chart(forecastCtx, {
            type: 'bar',
            data: {
                labels: {{ forecast_labels|safe }},
                datasets: [{
                    label: 'Expected Completion',
                    data: {{ forecast_months|safe }},
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444',
                        '#06b6d4', '#ec4899', '#6366f1', '#14b8a6', '#f97316'
                    ],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Months to Complete'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating forecast chart:', error);
    }

    // Calendar functionality
    let currentDisplayMonth = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
                       "July", "August", "September", "October", "November", "December"];

    function renderCalendar(date) {
        const calendarDays = document.getElementById('calendarDays');
        const currentMonth = document.getElementById('currentMonth');
        
        currentMonth.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        calendarDays.innerHTML = '';
        
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const totalDays = lastDay.getDate();
        
        let startOffset = firstDay.getDay() - 1;
        if (startOffset === -1) startOffset = 6;
        
        for (let i = 0; i < startOffset; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'p-2 border rounded bg-gray-50';
            calendarDays.appendChild(emptyCell);
        }
        
        const today = new Date();
        for (let day = 1; day <= totalDays; day++) {
            const cell = document.createElement('div');
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.getDate() === day && 
                           today.getMonth() === date.getMonth() && 
                           today.getFullYear() === date.getFullYear();
            
            cell.className = `border rounded p-2 relative ${isToday ? 'bg-blue-50 border-blue-200' : 'bg-white'}`;
            
            const dayContent = document.createElement('div');
            dayContent.className = 'flex justify-between items-center';
            
            const dayNumber = document.createElement('span');
            dayNumber.className = isToday ? 'font-bold text-blue-600' : '';
            dayNumber.textContent = day;
            dayContent.appendChild(dayNumber);
            
            const dateData = window.calendarData?.[dateStr];
            if (dateData) {
                const indicator = document.createElement('span');
                indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                dayContent.appendChild(indicator);
                
                if (dateData.amount) {
                    const amountDiv = document.createElement('div');
                    amountDiv.className = 'mt-1 text-xs text-green-600';
                    amountDiv.textContent = `₹${dateData.amount}`;
                    cell.appendChild(amountDiv);
                }
            }
            
            cell.appendChild(dayContent);
            calendarDays.appendChild(cell);
        }
    }

    document.getElementById('prevMonth')?.addEventListener('click', () => {
        currentDisplayMonth.setMonth(currentDisplayMonth.getMonth() - 1);
        renderCalendar(currentDisplayMonth);
    });

    document.getElementById('nextMonth')?.addEventListener('click', () => {
        currentDisplayMonth.setMonth(currentDisplayMonth.getMonth() + 1);
        renderCalendar(currentDisplayMonth);
    });

    window.calendarData = JSON.parse('{{ calendar_data|escapejs }}');
    renderCalendar(currentDisplayMonth);
});
</script>
{% endblock %}
{% endblock %} 